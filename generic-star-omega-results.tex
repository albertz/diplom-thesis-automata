\section{General results}
\label{general-results}

%S401: TODO

Let $\Lang$ be a $*$-language class. We start with some very basic results on language operators.

\subsection{Background}
\begin{lemma}
\label{gen:general}
Let $L,A,B \in \Lang$.
\begin{enumerate}
\item $\ext L = L \cdot \Sigma^\omega$
\item $\ext L = \lim(L \cdot \Sigma^*)$ %S303
\item $\ext L = \dlim(L \cdot \Sigma^*)$ %S303, S305.4
\item $- \lim(-L) = \dlim(L)$
\item $\dlim L \subseteq \lim L$
\item $\lim A \cup \lim B = \lim(A \cup B)$ %S305.4
\item $\dlim A \cup \dlim B \subseteq \dlim(A \cup B)$ \newline %S305.4
There is no equality in general: $A = (00)^*$, $B = (00)^*0$.
\end{enumerate}
\begin{proof}
\begin{enumerate}
\item[1.-5.] They all follow directly from the definition.
\item[6.] %S305.4
\begin{align*}
& \alpha \in \lim A \cup \lim B \\
\Leftrightarrow \ & \existsinf n \colon \alpha[0,n] \in A \ \vee \ \existsinf n \colon \alpha[0,n] \in B \\
\Leftrightarrow \ & \existsinf n \colon \alpha[0,n] \in A \cup B \\
\Leftrightarrow \ & \alpha \in \lim A \cup B
\end{align*}
\item[7.] %S305.4
\begin{align*}
& \alpha \in \dlim A \cup \dlim B \\
\Leftrightarrow \ & \exists N \colon \forall n \ge N \colon \alpha[0,n] \in A \ \vee \ 
\exists N \colon \forall n \ge N \colon \alpha[0,n] \in B \\
\Rightarrow \ & \exists N \colon \forall n \ge N \colon \alpha[0,n] \in A \cup B
\end{align*}
\end{enumerate}
\end{proof}
\end{lemma}

For $\omega$ automata, we already know that non-determinism can be more powerful than determinism (see \ref{reg-omega-lang}): The class of non-deterministic Büchi automata can accept clearly more languages than the class of determinstic Büchi automata. E.g. $L^\omega := (a+b)^* b^\omega \in \LangOreg$ cannot be recognised by deterministic Büchi automata, i.e. $L^\omega \not\in \lim \Langreg$.

Luckily, for E- and A-acceptance, this is not the case as we see below. This matches the intuition that E/A-acceptance doesn't really tell something about infinite properties of words but Büchi/Muller does. And when talking about finite words, we already know that non-deterministic and deterministic automata are equaly powerful (see chapter \ref{intro:reglang}).

%307.12
\begin{lemma}
\label{gen:e-determinism}
The $\omega$-language-class accepted by deterministic E-automata is equal to non-deterministic E-automata. I.e., for every non-deterministic E-automaton, we can construct an equivalent deterministic E-automaton. The same goes for A-automata.
\begin{proof} Let $\A^N$ be any non-deterministic automaton and $\A^D$ an ($*$-)equivalent deterministic automaton. Then:
\begin{align*}
& \alpha \in L^{\omega}_E(\A^N) \\
\Leftrightarrow \ & \exists n \colon \alpha[0,n] \in L(\A^N) \\
\Leftrightarrow \ & \exists n \colon \alpha[0,n] \in L(\A^D) \\
\Leftrightarrow \ & \alpha \in L^{\omega}_E(\A^D)
\end{align*}
$\A^N$ can be interpreted as an arbitary E-automata and we have shown that we get an equivalent deterministic E-automata.

For A-automata, the proof is analogue.
\end{proof}
\end{lemma}

\

%S302.1:
We are interested in relations like $\BC \ext \Lang \overset{?}{\subsetneqq} \BC \lim \Lang$ or $\ext \Lang \overset{?}{\subsetneqq} \lim \Lang$. With $\Lang = \Set{\Set{a}}$, we realize that even $\ext \Lang \subseteq \lim \Lang$ is not true in general ($\ext \Set{\Set{a}} = \Set{a \Sigma^\omega} \neq \emptyset = \lim \Set{\Set{a}}$). In lemma \ref{gen:non-suffix-sens}, we see a sufficient condition for this property, though.

We want to study all the properties we have shown for $\Langreg$ in lemma \ref{P:reg-star}.

\

We will formulate some properties of interest in a general form for a $*$-language class $\Lang$ which all hold for $\Langreg$. We get some general results based on these properties later in this chapter. %\ref{general-results}.

%S303.E3, S218, R101
Let $L,A,B \in \Lang$. Then there are the following properties on $\Lang$:
\begin{enumerate}
\item[1.] \defword{Closure under suffix-independence}: $L \cdot \Sigma^* \in \Lang$
\item[2a.] \defword{Closure under union}: $A \cup B \in \Lang$
\item[2b.] \defword{Closure under intersection}: $A \cap B \in \Lang$
\item[3.] \defword{Closure under complementation/negation}: $- L \in \Lang$

\item[4.]
\defword{Closure under change of final states}:
%S303.1:
In some proofs, e.g. in \ref{gen:staiger-wagner} or \ref{gen:kleene-star}, we have an automaton based on some language of the language class and we do some modifications on it, e.g. we modify the acceptance component. If there is a way to stay in the language class, the class is called to be \defword{closed under change of final states}. Formally:

There is a deterministic automaton $\A = (Q,\Sigma,q_0,\delta,F)$ with $L^*(\A) = L$ such that for all $F' \subseteq Q$, we have $L^*((Q,\Sigma,q_0,\delta,F')) \in \Lang$.

For $\Langreg$, this property holds obviously.

%S303.1.a:
Note that we cannot just take any automaton. For $\Lang^*(\mathrm{FO[<]})$ and the automaton below, it does not hold:

  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
%    on grid,
    auto,
%    state/.append style={minimum size=2em},
%    thick
  ]
    \node[state] (S)              {};
    \node[state,double] (A) [right of=S] {$A$};
    \node[state] (B) [below of=S] {$B$};
    \node[state] (C) [right of=B] {};

    \path[->] (S) +(-1,0) edge (S)
              (S)         edge              node {$a$} (A)
              (S)         edge              node {$b$} (B)
              (B)         edge  [bend left]            node {$b$} (C)
              (C)         edge  [bend left]            node {$b$} (B)
              ;
  \end{tikzpicture}
  
This is a deterministic automaton for the language $\Set{a} \in \Lang^*(\mathrm{FO[<]})$. If you make $B$ also a final state, we get the language $a + b(bb)^* \not\in \Lang^*(\mathrm{FO[<]})$.

%S303.1: TODO: weniger ...

\end{enumerate}


\subsection{Classification for arbitrary language classes}
\label{gen:general}

%\subsection{non suffix sensitive}
% S303, S101a:
\begin{lemma}
\label{gen:non-suffix-sens}
If $\Lang$ is closed under suffix-independence,
\[ \ext \Lang \subseteq \lim \Lang \cap \dlim \Lang . \]
\begin{proof}
For $L \in \Lang$, we have $\ext L = L \Sigma^\omega = \lim (L \Sigma^*) = \dlim (L \Sigma^*)$.
\end{proof}
\end{lemma}

%\subsection{$\BC \ext \subseteq \BC \lim$}
%S302:
\begin{lemma}
\label{gen:S302a} If we have $\ext \Lang \subseteq \lim \Lang$, then we also have
\[ \BC \ext \Lang \subseteq \BC \lim \Lang . \]
\begin{proof}
From $\ext \Lang \subseteq \lim \Lang$, it directly follows $\Set{-\ext L}{L \in \Lang} \subseteq \Set{-\lim L}{L \in \Lang}$. Thus, it also follows the claimed inequality.
\end{proof}
\end{lemma}

%\subsection{$\dext \subset \dlim$}
%S302:
\begin{lemma}
If we have $\ext \Lang \subseteq \lim \Lang$ and let $\Lang$ be closed under negation. Then we have
\[ \dext \Lang \subseteq \dlim \Lang . \]
\begin{proof}
Let $L \in \Lang$. Then $ \dext L = - \ext (-L) $. Because of the negation closure, we also have $-L \in \Lang$ and $\ext(-L) \in \ext \Lang$. Thus $\lim(-L) \in \lim \Lang$. Thus, $-\lim(-L) \in \Set{-\lim A}{A \in \Lang} = \Set{\dlim A}{-A \in \Lang}$. Because of the negation closure, this is equal to $\Set{\dlim A}{A \in \Lang} = \dlim \Lang$. I.e. $\dlim L \in \dlim \Lang$.
\end{proof}
\end{lemma}

Note that we needed the negation closure in the proof. This is in contrast to \ref{gen:S302a}, where it directly follows. We have to be careful about the difference $- \ext \Lang := \Set{-\ext L}{L \in \Lang} \neq \dext \Lang$ (in general, if $\Lang$ is not closed under negation).

%\subsection{union, intersection}
%S303:
\begin{lemma}
\begin{itemize}
\item
$\Lang$ closed under union $\Rightarrow \bigcup \ext \Lang \subseteq \ext \Lang$.
\item
$\Lang$ closed under intersection $\Rightarrow \bigcap \ext \Lang \subseteq \ext \Lang$.
\end{itemize}
\begin{proof}
Let $A,B \in \Lang$. Then we have $\ext(A\cup B) = \ext(A) \cup \ext(B)$ and $\ext(A\cap B) = \ext(A) \cap \ext(B)$.
\end{proof}
\end{lemma}

%\subsection{$op \cup \overline{op} \subsetneqq \BC op$}
\begin{lemma}
Let $\Lang$ be closed under negation. Then
\[ \ext \cup \dext \Lang \subsetneqq \BC \ext \Lang . \]
\begin{proof}
If there is $L_\Sigma \in \Lang_\Sigma$ with $L_\Sigma \in \ext \Lang_\Sigma, L_\Sigma \not\in \dext \Lang_\Sigma$ and E3 (closed under negation) holds for $\Lang$:
\begin{itemize}
\item[$\Rightarrow$] $-L_\Sigma \in \dext \Lang_\Sigma, -L_\Sigma \not\in \ext \Lang_\Sigma$
\item[$\Rightarrow$] $L_{\Sigma_1} \cup -L_{\Sigma_2} \in \BC \ext \Lang_{\Sigma_1 \dot{\cup} \Sigma_2}$ \newline
$L_{\Sigma_1} \cup -L_{\Sigma_2} \not\in \ext \cup \dext \Lang_{\Sigma_1 \dot{\cup} \Sigma_2}$
\end{itemize}
Thus, $ \ext \cup \dext \Lang \subsetneqq \BC \ext \Lang$.
\end{proof}
\end{lemma}

Similarily:

\begin{lemma}
Let $\Lang$ be closed under negation. Then
\[ \lim \cup \dlim \Lang \subsetneqq \BC \lim \Lang . \]
\begin{proof}
If there is $L_\Sigma \in \lim \Lang_\Sigma, L_\Sigma \not\in \dlim \Lang_\Sigma$ and E3 holds for $\Lang$:
\begin{itemize}
\item[$\Rightarrow$] $-L_\Sigma \in \dlim \Lang_\Sigma, -L_\Sigma \not\in \lim \Lang_\Sigma$
\item[$\Rightarrow$] $L_{\Sigma_1} \cup -L_{\Sigma_2} \in \BC \lim \Lang_{\Sigma_1 \dot{\cup} \Sigma_2}$ \newline
$L_{\Sigma_1} \cup -L_{\Sigma_2} \not\in \lim \cup \dlim \Lang_{\Sigma_1 \dot{\cup} \Sigma_2}$
\end{itemize}
Thus, $ \lim \cup \dlim \Lang \subsetneqq \BC \lim \Lang $.
\end{proof}
\end{lemma}

%\subsection{$\BC \ext = \lim \cap \dlim$}
\begin{mydef}
\label{def:staiger-wagner}
A \defword{Staiger-Wagner automaton} (also called \defword{weak Muller automaton}) is of the same form $\A = (Q,\Sigma,q_0,\delta,\F)$ with acceptance component $\F \subseteq 2^Q$ like a Muller automaton with the acceptance condition that a run $\rho$ in $\A$ is accepting if and only if $\Occ(\rho) := \Set{q \in Q}{\text{$q$ occurs in $\rho$}} \in \F$.  (\cite[Def.61, p.43]{InfCompR101})
\end{mydef}

\begin{theorem}
\label{thm:staiger-wagner}
%S405:
We see that the class of Staigner-Wagner-recognized languages is exactly the class $\BC \ext \Langreg$ and also $\lim \cap \dlim \Langreg$. And thus:
\[ \BC \ext \Langreg = \lim \cap \dlim \Langreg . \]
\begin{proof}
See \cite[Theorem 63+64, p.44]{InfCompR101}.
\end{proof}
\end{theorem}

We are now formulating a more general and direct proof for the $\BC \ext \Lang = \lim \cap \dlim \Lang$ equality without Staiger-Wagner-automata (where some of the ideas are loosely based on \cite[Theorem 63+64, p.44]{InfCompR101}).

\

\begin{lemma}
\label{gen:staiger-wagner}
Let $\Lang$ be closed under suffix-independence, negation, union and change of final states. Then
\[ \BC \ext \Lang = \lim \cap \dlim \Lang . \]

\begin{proof}
%S305:
First, we show $\lim \cap \dlim \Lang \subseteq \BC \ext \Lang$.

Let $\tilde L \in \lim \cap \dlim \Lang$, i.e. there are deterministic automaton $\A$ and $\overline \A$ so that $L^\omega_{\text{Büchi}}(\A) = L^\omega_{\text{co-Büchi}}(\overline \A) = \tilde L$. Let $Q,\overline Q$ be the states of $\A,\overline \A$. Now look at the product automaton $\A \times \overline \A =: \Ax$ with states $Q \times \overline Q$ and final states $F \times \overline F \subseteq Q \times \overline Q$. $\Ax$ is also deterministic.

%Let $(q,\overline q) \in Q \times \overline F$. If $\overline q$ is not part of a loop in $\A$, we can just take it away from $\overline F$ and get the same $\omega$-language (no matter if Büchi or co-Büchi). Thus assume that all $\overline q \in \overline F$ are part of a loop.

%Let $\alpha \in \tilde L$. Then $\rho(\alpha)$ has infinity many occurences in $F$ and there is some $N$ so that $\overline \rho(\alpha)[N,\infty)$ is only in $\overline F$. Let $\beta \not\in \tilde L$. Then there is some $N$ so that $\rho(\alpha)[N,\infty)$ is only in $Q-F$.

%S305.1
In $\Ax$, we have
\begin{align*}
& \alpha \in \tilde L \\
\Leftrightarrow \ & \forall N \colon \exists n \ge N \colon \overx{\rho}(\alpha)[n] \in F \times \overline Q \\
\Leftrightarrow \ & \exists N \colon \forall n \ge N \colon \overx{\rho}(\alpha)[n] \in Q \times \overline F
\end{align*}

Look at a strongly connected component (SCC) $S$ in $\Ax$. We have $S \cap F \times \overline Q \neq \emptyset$, iff $S$ accepts. It follows that all states in $S$ are finite states in $\overline \A$, i.e. $S \cap Q \times \overline F = S$.

Single $\overx{q} \in \overx{Q}$ which are not part of a SCC can be ignored. For the acceptance of infinte words, only SCCs are relevant. For $S$, define $S_+ := \Set{\overx{q} \in \overx{Q}-S}{\overx{q} \text{ can be visited after } S}$.

Then we have
\begin{align*}
\tilde L = \bigcup_{\text{SCC } S} & S \text{ will be visited} \ \wedge \\
& \text{all states of } S \text{ will be visited forever after some step} \ \wedge \\
& S_+ \text{ will not be visited} .
\end{align*}

%S305.2:
$S$ will be visited: Let $S$ exactly be the finite states. This interpreted as an E-automaton $\A^E_S$ is exactly the condition.

Only the allowed states will be visited but nothing followed after $S$: Mark $S$ and all states on all paths to $S$ as finite states. This as an A-automaton $\A^A_S$ is exactly the condition.

A similar negated condition might be simpler: Let $S_+$ be exactly the finite states. Interpret this as an E-automaton $\A^E_{S_+}$.

Then we have
\begin{align*}
\tilde L & = \bigcup_{\text{SCC } S} L^\omega_E (\A^E_S) \cap L^\omega_A (\A^A_S) \\
& = \bigcup_{\text{SCC } S} L^\omega_E (\A^E_S) \cap -L^\omega_E (\A^E_{S_+}) .
\end{align*}

Thus,
\[ \tilde L \in \BC \ext \Langreg . \]
Given the \emph{closure under change of final states}, we have $L^*(\A^E_S), L^*(\A^E_{S_+}) \in \Lang$, i.e.
\[ \tilde L \in \BC \ext \Lang . \]

\

%S305.3:
Now let us show $\BC \ext \Lang \subseteq \lim \Lang$.

With the \emph{closure under suffix-independence}, we get $\ext \Lang \subseteq \lim \Lang$ and $\ext \Lang \subseteq \dlim \Lang$. I.e. $\ext \Lang \subseteq \lim \cap \dlim \Lang$. Let us show that $\lim \cap \dlim \Lang$ is closed under boolean closure.

Let $\tilde L_a,L_b \in \lim \cap \dlim \Lang$, i.e. $\exists L_{a1}, L_{a2}, L_{b1}, L_{b2} \in \Lang \colon \tilde L_a = \lim L_{a1} = \dlim L_{a2}, \tilde L_b = \lim L_{b1} = \dlim L_{b2}$. Let us show 1. $-\tilde L_a \in \lim \cap \dlim \Lang$, 2. $\tilde L_a \cup \tilde L_b \in \lim \cap \dlim \Lang$.
\begin{enumerate}
\item $-\tilde L_a = -\lim L_{a1} = \dlim -L_{a1}$, $-\tilde L_b = -\dlim L_{a2} = \lim -L_{a2}$. With the \emph{closure under negation}, we get
\[ -\tilde L_a \in \lim \cap \dlim \Lang . \]

\item
$\tilde L_a \cup \tilde L_b = \lim L_{a1} \cup \lim L_{b1} = \lim L_{a1} \cup L_{b1}$ (\ref{gen:general}). Thus, with \emph{closure under union}, we have
\[ \tilde L_a \cup \tilde L_b \in \lim \Lang . \]

The $\dlim\Lang$ case is harder.
%S305.5: language theoretical proof: TODO
%S305.6:
Let $\A_a$, $\A_b$ be deterministic automaton, so that $L^\omega_{\text{Büchi}}(\A_a) = L^\omega_{\text{co-Büchi}}(\A_a) = \tilde L_a$, $L^\omega_{\text{Büchi}}(\A_b) = L^\omega_{\text{co-Büchi}}(\A_b) = \tilde L_b$. Look at the product automaton $\A_a \times \A_b =: \Ax$. Then we have $L^\omega_{\text{Büchi}}(\Ax) = L^\omega_{\text{co-Büchi}}(\Ax) = \tilde L_a \cup \tilde L_b$.

Thus,
\[ \tilde L_a \cup \tilde L_b \in \dlim \Langreg . \]

Again, given the \emph{closure under change of final states}, we have $L^*(\Ax) \in \Lang$.

\end{enumerate}
\end{proof}
\end{lemma}

%S406.1: TODO...
%S402: TODO...

%\subsection{Kleene-star $= \BC \lim$}
\begin{lemma}
\label{gen:kleene-star}
Let $\Lang$ be closed under change of final states. Then
\[ \BC \lim \Lang = \Kleene \Lang . \]

\begin{proof}
%S407: TODO...
%S306, S306.1:
Let $U,V \in \Lang$. Look at the non-deterministic automaton $\A$ defined as:
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node (U)              {$U$};
    \node (V) [right of=U] {$V \odot$};

    \path[->] (U) +(-1,0) edge (U)
              (U)         edge              node {$\epsilon$} (V)
              (V)         edge  [loop above]       node {} ()
              ;
  \end{tikzpicture}
\]

Then we have $L^\omega_{\text{Büchi}}(\A) = U \cdot V^\omega$.

Let us construct deterministic automata for $\A$ so that we can formulate 'V will be visited and not be left anymore' and 'finite states of the V-related automaton will be visited infinitely often' (or '$UV^*$ will be visited infinitely often').

In a constructed automaton, we must be able to tell wether we are in $U$ or we deterministically have been in $U$ the previous state. In a state power set construction, we can tell wether we are deterministically in $U$ or not. If we are non-determinstic and we may be in both $U$ or $V$ and we get an input symbol which determines that we have been in $U$, we might not be able to tell from the following power set.

Example:

Let $U = (a+b)^*$, $V = \Set{b}$. I.e. $UV^\omega = \Set{\alpha \in \Set{a,b}^\omega}{\text{at one point in $\alpha$, there are only $b$s}}$. The non-deterministic automaton is:
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node[state] (1)              {$1$};
    \node[state,double] (2) [right of=1] {$2$};
	
    \path[->]
    (1) +(-1,0) edge (1)
    (1) edge [loop above] node {$a,b$} ()
    (1) edge node {$\epsilon$} (2)
    (2) edge [loop above] node {$b$} ()
    ;
  \end{tikzpicture}
\]

Powerset construction: The initial state is $\Set{1,2}$. Then we have:
\begin{itemize}
\item $\Set{1,2} \overset{a}\rightarrow \Set{1,2}$
\item $\Set{1,2} \overset{b}\rightarrow \Set{1,2}$
\end{itemize}
This gives the $*$-language $\Set{a,b}^*$ and we cannot formulate $UV^\omega$ in any way from there.

In the construction, when we got the $a$ from $\Set{1,2}$, we knew that we have been deterministically in $1$, i.e. in $U$. We loose this information. To keep it, we introduce another state flag which exactly says wether we have determined that we have been in $U$. Thus, we construct an automaton with the states $\Power(Q) \times \B_{\text{det. been in $U$}}$, where $Q$ are the states from $\A$.

For the example, we get the initial state $(\Set{1,2},1)$. Then we have:
\begin{itemize}
\item $(\Set{1,2},1) \overset{a}\rightarrow (\Set{1,2},1)$
\item $(\Set{1,2},1) \overset{b}\rightarrow (\Set{1,2},0)$
\item $(\Set{1,2},0) \overset{a}\rightarrow (\Set{1,2},1)$
\item $(\Set{1,2},0) \overset{b}\rightarrow (\Set{1,2},0)$
\end{itemize}
This is the automaton
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node[state] (1)              {$\Set{1,2},1$};
    \node[state] (2) [right of=1] {$\Set{1,2},0$};

    \path[->]
    (1) +(-1.5,0) edge (1)
    (1) edge [loop above] node {$a$} ()
    (1) edge [bend left] node {$b$} (2)
    (2) edge [bend left] node {$a$} (1)
    (2) edge [loop above] node {$b$} ()
    ;
  \end{tikzpicture}
\]

When we mark all states from $V$ and where we have not been deterministically in $U$ as final, this as a co-Büchi automaton gives exactly the condition 'V will be visited and not be left anymore'. Let $L_E$ be the $*$-language of this automata. Note that $L_E \neq UV^*$ in general and esp. in the example.

When we mark the final states as in the original non-deterministic automata, no matter about $\B_{\text{det. been in $U$}}$, with Büchi-acceptance, we get the condition '$UV^*$ will be visited infinitely often'. This is just $\lim UV^*$.

Together, we get $UV^\omega$, i.e.:
\[ \lim UV^* \cap \dlim L_E = UV^\omega \]

Given the \emph{closure under change of final states}, we have $L_E \in \Lang$. Then, it follows
\[ \Set{ \bigcup_{i=1}^n U_i \cdot V_i^\omega}{U_i, V_i \in \Lang} = \Kleene \Lang \subseteq \BC \lim \Lang . \]

\

We also need to show $\BC \lim \Lang \subseteq \Kleene \Lang$.

%S306.3:
Show: $\lim \Lang \subseteq \Kleene \Lang$.

Proof: Let $\A$ be a deterministic Büchi automaton for some language $\tilde L = L^\omega_{\text{Büchi}}(\A) \in \Lang$ with final states $F$.

For all finite states $q \in F$: If $q$ is not part of a strongly connected component (SCC), we can ignore it. Let $S$ be the SCC where $q \in S$. Then the set of all $\alpha \in \Sigma^\omega$ which are infinitely often in $q$ can be described as $U_q \cdot V_q^\omega$, where $U_q$ is the set of words so that we arrive in $q$ and $V_q$ is the set of words so that we get from $q$ to $q$. Both sets are regular.

Thus,
\[ \tilde L = L^\omega_{\text{Büchi}}(\A) = \bigcup_{q \in F} U_q V_q^\omega . \]

Obviously, the Kleene-Closure is closed under union.

TODO: Show that Kleene-Closure is closed under negation. (S306.5) (Follows with non-det Büchi complementation but a more generic proof might be useful.)
\end{proof}
\end{lemma}

\subsection{Congruence based language classes}

\subsubsection{Introduction}
\label{gen:R-automata}

\begin{mydef}
We define $\Lang(R)$ for an equivalence relation $R\subseteq\Sigma^* \times \Sigma^*$
\[ \Lang^*(R) := \Set{L \subseteq \Sigma^*}{L \text{ is finite union of $R$-equivalence-classes}} . \]
\end{mydef}

Examples of such language classes are locally testable (LT, section \ref{lang:LT}), locally threshold testable (LTT, section \ref{lang:LTT}) or piece-wise testable (PT, section \ref{lang:PT}) languages. At their definition, the word-relation basically tells wether a local test / piece-wise test can see a difference between two words.

%S307
If a language class $\Lang(R)$ is defined as finite union of equivalence classes of a relation $R \subseteq \Sigma^* \times \Sigma^*$ and
\begin{itemize}
\item the set of equivalent classes of $R$ is finite,
\item $R$ is a congruence relation, i.e. also $(v,w) \in R \ \Leftrightarrow \ (va,wa) \in R \ \ \forall a \in \Sigma$
\end{itemize}
then we can construct a canonical deterministic automaton $\A_R$ which has $S_R := \Sigma^* / R$ as states, $\left<\epsilon\right>_R$ is the initial state and the transitions are according to concatenation. Call this an $R$-automaton.

The LT, LTT and PT language classes have the above properties and thus such related canonical automaton.

The set of all such $R$-automata, varying in the final state set, is isomprophic to $\Lang(R)$. We have
\[ \Lang^*(R) = \Set{L^*(\A_R(F))}{F \subseteq S_R} =: \Lang^*(\A_R) . \]

Obviously, by construction, such language classes are all \emph{closed under change of final states}. Obviously, $\Lang^*(R)$ is also closed under \emph{negation, union and intersection} (via negating, merging or intersecting the final state set of related automata). \emph{Closure under suffix-independence} doesn't directly follow from this --- we see some counter example later.

\begin{mydef}
Analogously for $\omega$, we get the set of $R$-E-automata with the $\omega$-language-class
\[ \Lang^\omega_E(\A_R) := \Set{L^\omega(\A^E_R(F))}{F \subseteq S_R} , \]
$R$-Büchi-automata and
\[ \Lang^\omega_{\text{Büchi}} (\A_R) := \Set{L^\omega(\A_R^{\text{Büchi}}(F))}{F \subseteq S_R} , \]
$R$-Muller-automata and
\[ \Lang^\omega_{\text{Muller}} (\A_R) := \Set{L^\omega(\A_R^{\text{Muller}}(\F))}{\F \subseteq 2^{S_R}} . \]
\end{mydef}

%S307.1
\begin{mydef}
For a relation $R$ on $\Sigma^*$, there are various ways to construct a relation on $\Sigma^\omega$. For now, we mainly study $R^\omega := \dext R$, i.e.
\[ (\alpha,\beta) \in R^\omega \ :\Leftrightarrow \ \forall n \colon (\alpha[0,n],\beta[0,n]) \in R . \]

Analogously to $\Lang(R)$, define the $\omega$-language-class
\[ \Lang^\omega(R^\omega) := \Set{L^\omega \subseteq \Sigma^\omega}{\text{$L^\omega$ is finite union of $R^\omega$-equivalence-classes}} . \]
\end{mydef}

\subsubsection{Classification}

With this preparation, we get some obvious results:
\begin{lemma}
$\Lang(R)$ is closed under negation, union, intersection and change of final states.
\begin{proof}
This all follows directly from manipulations on final states of the canonical $R$-automata via negation, union, intersection or general change of final states.
\end{proof}
\end{lemma}

\begin{example}
There is an $R$ such that $\Lang(R)$ is \textbf{not} closed under suffix-independence.
\begin{proof}
Look at the transition graph over $\Sigma := \Set{a,b}$:
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node[state] (0)              {$0$};
    \node[state] (1) [right of=0] {$1$};
    \node[state] (2) [below of=0] {$2$};

    \path[->]
    (0) +(-1.5,0) edge (0)
    (0) edge [bend left] node {$a$} (1)
    (0) edge [bend right] node {$b$} (2)
    (1) edge [bend left] node {$a$} (2)
    (1) edge [bend left] node {$b$} (0)
    (2) edge [loop below] node {$a,b$} ()
    ;
  \end{tikzpicture}
\]
Define the congruence relation $R \subseteq (\Sigma^*,\Sigma^*)$ as $(v,w) \in R \ :\Leftrightarrow \ v,w$ end up in the same state. Then, the above transition graph is exactly the $R$-automaton.

If $1$ is the only final state, this is the language $L_1 = a(ba)^*$. With suffix independence, we get the language $L_1 \cdot \Sigma^* = a \Sigma^*$.

$a \Sigma^* \not\in \Lang(R)$, thus $\Lang(R)$ is not \emph{closed under suffix-independence}.

Furthermore, $\ext L_1 = a \Sigma^\omega$. Marking $0$ or $1$ as final state in a $R$-Büchi-automaton accepts the language $\tilde L_1 := \Set{(ab)^\omega}$. Marking $2$ as final state accepts the language $\tilde L_2 := (ab)^* (b | aa) \Sigma^\omega$. Then, $\lim \Lang(R) = \Set{\emptyset, \tilde L_1, \tilde L_2, \tilde L_1 \cup \tilde L_2}$. And we have $\ext L_1 \not\in \lim \Lang(R)$. But we also have $\tilde L_1 \not\in \ext \Lang(R)$.
\end{proof}
\end{example}

In the rest of this section, we show some equalities:
\begin{itemize}
\item $\Lang^\omega_E(\A_R) = \ext \Lang(R)$ (lemma \ref{gen:lang_omega_e})
\item $\Lang^\omega_{\text{Büchi}}(\A_R) = \lim \Lang(R)$ (lemma \ref{gen:lang_omega_buechi})
\item $\Lang^\omega_{\text{Muller}}(\A_R) = \BC \lim \Lang(R)$ (lemma \ref{gen:lang_omega_muller})
\item $\Lang^\omega(R^\omega) = \BC \ext \Lang(R)$ (lemma \ref{gen:Romega=BCextR})
\item $\BC \lim \Lang(R) \cap \ext \Langreg = \ext \Lang(R)$ (lemma \ref{gen:R-bclim-cap-ext})
\item $\lim \Lang(R) \cap \dlim \Lang(R) = \BC \ext \Lang(R)$ (lemma \ref{gen:R-staiger-wagner})
\end{itemize}

We will see that all those equations hold for all $R$, i.e. also for $\Lang(LT_n)$, $\Lang(LTT^k_n)$ and $\Lang(PT_n)$.

We will also see that $\BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R)$ is not always the case. We will give an alternative characterization of this property (theorem \ref{gen:postfix-loop-det=limAndBclim}).

\begin{lemma}
%\subsection{$\Lang^\omega_E(\A_R) = \ext \Lang(R)$}
%S307.2,S307.3
\label{gen:lang_omega_e}
\[ \Lang^\omega_E(\A_R) = \ext \Lang(R) \]
\begin{proof}
Let $L = \bigcup_i \left< w_i\right>_R, L \in \Lang(R)$. Then
\begin{align*}
& L^\omega = \ext L \\
\Leftrightarrow \ & L^\omega = \Set{\alpha \in \Sigma^\omega}{\exists n \colon \alpha[0,n] \in \bigcup_i \left< w_i\right>_R} \\
\Leftrightarrow \ & L^\omega = \Set{\alpha \in \Sigma^\omega}{\exists n \colon \delta_{\A_R}(\alpha[0,n]) \in \Set{\left< w_i\right>_R \subseteq S_R}{i}} \\
\Leftrightarrow \ & L^\omega = L^\omega(\A^E_R(\Set{\left< w_i\right>_R \subseteq S_R}{i}))
\end{align*}
\end{proof}
\end{lemma}

\begin{lemma}
%\subsection{$\Lang^\omega_{\text{Büchi}}(\A_R) = \lim \Lang(R)$}
%S307.2,S307.3
\label{gen:lang_omega_buechi}
\[ \Lang^\omega_{\text{Büchi}}(\A_R) = \lim \Lang(R) \]
\begin{proof}
Let $L = \bigcup_i \left< w_i\right>_R, L \in \Lang(R)$. Then
\begin{align*}
& L^\omega = \lim L \\
\Leftrightarrow \ & L^\omega = \Set{\alpha \in \Sigma^\omega}{\exists^\infty n \colon \alpha[0,n] \in \bigcup_i \left< w_i\right>_R} \\
\Leftrightarrow \ & L^\omega = \Set{\alpha \in \Sigma^\omega}{\exists^\infty n \colon \delta_{\A_R}(\alpha[0,n]) \in \Set{\left< w_i\right>_R \subseteq S_R}{i}} \\
\Leftrightarrow \ & L^\omega = L^\omega(\A^{\text{Büchi}}_R(\Set{\left< w_i\right>_R \subseteq S_R}{i}))
\end{align*}
\end{proof}
\end{lemma}

\begin{lemma}
%\subsection{$\Lang^\omega_{\text{Muller}}(\A_R) = \BC \lim \Lang(R)$}
%S307.2,S307.3
\label{gen:lang_omega_muller}
\[ \Lang^\omega_{\text{Muller}}(\A_R) = \BC \lim \Lang(R) \]
\begin{proof}
Any $L^\omega \in \BC \lim \Lang(R)$ can be described by $\BC 2^{S_R}$. $2^{2^{S_R}}$ is also finite. Thus, any $A \in \BC 2^{S_R}$ can be represented in $2^{2^{S_R}}$. This is exactly an acceptance condition in Muller.
\end{proof}
\end{lemma}

\begin{lemma}
%\subsection{$\Lang^\omega(R^\omega) = \BC \ext \Lang(R)$}
%S307.4,S307.5
\label{gen:Romega=BCextR}
\[ \Lang^\omega(R^\omega) = \BC \ext \Lang(R) \]
\begin{proof}
TODO...
\end{proof}
\end{lemma}

When we compare the outer $\ext \Langreg$ (inside $\BC \lim \Langreg$, i.e. all regular $\omega$-languages) which is clearly a superset of $\ext \Lang$ and the inner whole class $\BC \lim \Lang$, a natural question is wether $\BC \lim \Lang \cap \ext \Langreg = \ext \Lang$. This is the case for $\Lang(R)$ as shown below.

\begin{lemma}
%\subsection{$\BC \lim \Lang(R) \cap \ext \Langreg = \ext \Lang(R)$}
%S307.6,S307.7,S307.8
\label{gen:R-bclim-cap-ext}
\[ \BC \lim \Lang(R) \cap \ext \Langreg = \ext \Lang(R) \]

\begin{proof}
We have $\ext \Lang(R) \subseteq \ext \Langreg$ and $\ext \Lang(R) \subseteq \BC \lim \Lang(R)$. Thus, "$\supseteq$" is shown.

Now, we show "$\subseteq$". Let $L^\omega \in \BC \lim \Lang(R) \cap \ext \Langreg$. Because $L^\omega \in \ext \Langreg$, there is an E-automaton $\A^E$ which accepts $L^\omega$. We can assume that $\A^E$ is deterministic (with \ref{gen:e-determinism}).

We must find an $R$-E-automaton which accepts $L^\omega$. We will call it the $\overline{\A}^M$ E-automaton and will construct it in the following.

Let $\A^M$ be the deterministic $R$-Muller-automaton for $L^\omega$ (according to \ref{gen:R-automata} and \ref{gen:lang_omega_muller}). Without restriction, there are no final state sets in $\A^M$ which are not loops. Then, $\overline{\A}^M$ has the same states and transitions as $\A^M$.

Look at a final state $q^E$ of $\A^E$. Without restriction, we can assume that there is no path that we can reach multiple final states at once. Let $L_{q^E}$ be all words which reach $q^E$ exactly once at the end.

Let $w \in L_{q^E}$.
%In $\A^M$, after $w$, we reached a state where anything that follows will eventually reach a SCC where any possible looping subset is an element of the final state set of $\A^M$ and there is no way out of the SCC.
%Look at some SCC $S$ in $\A^M$. Let $q \in S$. Let $\F$ be the subset of the finite state set of $\A^M$ so that $q \in F$ for all $F \in \F$, i.e. $F \cap S \neq \emptyset$. We can ignore all $F$ which are not a loop because they would not accept anything because they cannot be reached infinitely often. Because $S$ is a SCC and $F$ is a loop, we also get $F \subseteq S$.
Let $q$ be the state in $\A^M$ which is reached after $w$. Let $S$ be the set of states in $\A^M$ which can be reached from $q$.
%Let $\F$ be the subset of the finite state set of $\A^M$ so that $F \cap S \neq \emptyset$ for all $F \in \F$. We also get $F \subseteq S$.

Then, $\A^M$ accepts all words in $L_q \cdot L_{q,S}^\omega$, where $L_q$ is the set of words to $q$ and $L^\omega_{q,S}$ is the set of words of possible infinite postfixes after $q$ in $S$ so that they are accepted.
%loops $q\rightarrow q$ in $\F$.
Any word with a prefix in $L_q$, which is not in $L_q \cdot L^\omega_{q,S}$, will not be accepted by $\A^M$ because $\A^M$ is deterministic. Also, because $L_{q^E} \cap L_q \neq \emptyset$ and $L_{q^E} \cdot \Sigma^\omega \subseteq L^\omega$ and $L_q \cdot L^\omega_{q,S} \subseteq L^\omega$, we get $L^\omega_{q,S} \neq \emptyset$.

Assuming $L^\omega_{q,S} \neq \Sigma^\omega$. Then we would have $L^\omega \not\in \ext \Langreg$, which is a contradiction. I.e. $L^\omega_{q,S} = \Sigma^\omega$.

Thus, $\A^M$ accepts all words in $L_q \cdot \Sigma^\omega$. Mark $q$ as a final state in $\overline{\A}^M$. Thus, $\overline{\A}^M$ E-accepts all words in $L_q \cdot \Sigma^\omega \subseteq L^\omega$.

%For any state $\tilde q$ in $\A^M$ which is not marked as a final state in the previously described way, all states in $\A^E$ after words in $L_{\tilde q}$ are not final states in $\A^E$. Thus, all words not in $L^\omega$ are not accepted by $\overline{\A}^M$.

Because we did this for all final states in $\A^E$, there is no $\alpha \in L^\omega$ which is not accepted by $\overline{\A}^M$. I.e., the $R$-E-automata $\overline{\A}^M$ accepts exactly $L^\omega$. I.e. $L^\omega \in \ext \Lang(R)$.
\end{proof}
\end{lemma}

In fact, we actually have shown $\BC \lim \Lang \cap \ext \Langreg = \ext \Lang$ for any $\Lang \subseteq \Langreg$.


We are also interested in the equality $\BC \lim \Lang \cap \lim \Langreg = \lim \Lang$ for some $*$-language class $\Lang \subseteq \Langreg$. This is a connection between the outer $\lim \Langreg$ (inside $\BC \lim \Langreg$) which is clearly a superset of $\lim \Lang$ and the inner whole class $\BC \lim \Lang$. It turns out that this is not always the case and not as straightforward as in the $\ext$ case in lemma \ref{gen:R-bclim-cap-ext}.

We have $\lim \Lang \subseteq \lim \Langreg$ and $\lim \Lang \subseteq \BC \lim \Lang$. Thus, "$\supseteq$" does hold in all cases.

\begin{example}
\label{gen:bcLimLReg-and-limL:counter-example}
The equality does not hold for any $\Lang$.
\begin{proof}
Let $\Sigma = \Set{a,b}$,
\[ L_a := (b^* a^+) (b^+ a^+)^* , \ \ \ L_b := b^* (a^+ b^+)^* \ \ \ \text{and} \ \ \ \Lang := \Set{L_a,L_b} . \]
Then, $\lim L_a$ is the set of words where $a$ occurs infintely often and $\lim L_b$ is the set of words where $b$ occurs infinitely often. Then, $L_\omega := \lim L_a \cap \lim L_b \in \BC \lim \Lang$. Also, let
\[ L_{ab} := (a^* b^+ a)^* . \]
Then, $\lim L_{ab}$ is the set of words where both $a$ and $b$ occurs infintely often. Thus, $\lim L_{ab} = L_\omega$. Obviously, we also have $L_{ab} \in \Langreg$. Thus, $L_\omega \in \BC \lim \Lang \cap \lim \Langreg$. But we can also see that $L_\omega \not\in \lim \Lang$.
\end{proof}
\end{example}

Thus, we need some conditions on $\Lang$ for the equality. Here, we will study the class $\Lang(R)$. We will introduce a property on $\Lang(R)$ where we can show the equality. The idea of this property is comming from the study of this equality in terms of automata. Let $L_\omega \in \BC \lim \Lang(R)$. Then there is a representing $R$-Muller-automaton $\A_M$ for $L_\omega$. Let also $L_\omega \in \lim \Langreg$. Then there is representing deterministic Büchi automaton $\A_r$ for $L_\omega$. We want to show that $L_\omega \in \lim \Lang(R)$. I.e. we are searching for a representing deterministic automaton whose language is in $\Lang(R)$ and where the Büchi-acceptance gives us $L_\omega$. Because the $R$-Büchi-automaton is the canonical deterministic Büchi automaton for $\Lang(R)$, we must be able to construct such $R$-Büchi-automaton $\A_B$ for $L_\omega$. Let us look at the product automaton $\A_M \times \A_r$ and determine from there the final state set of $\A_B$. $\A_M$ already has the right transition graph. $\A_r$ has the Büchi acceptance. So, when looking at the product automaton, we try to find the loops in $\A_M$ which match a final state in $\A_r$. $\A_r$ might be bigger than $\A_M$ and it doesn't seem clear wether the Muller final state sets of $\A_M$ can be translated to a Büchi final state set. However, when we say that each SCC in $\A_M$ has exactly one loop, there is no inconclusiveness about wether there is a Büchi final state in this SCC in $\A_B$ or not. We will formulate this formally below. So, if we have that property on $\A_M$, i.e. on $\Lang(R)$, we can construct $\A_B$ and thus we have the equality.

\begin{mydef}
For $\alpha \in \Sigma^\omega$, let $\overrightarrow \alpha \in (\Sigma^* / R)^\omega$ be the state sequence we run through with $\alpha$ and thus $\Inf(\overrightarrow \alpha) \subseteq \Sigma^*/R$ those states which are visited infinitely often.

If for every $L \in \Lang(R)$, there is an inclusion function $B_L \colon \Sigma^*/R \rightarrow \B$ such that for every $\alpha \in \Sigma^\omega$, we have
\[ \alpha \in L \ \ \ \Leftrightarrow \ \ \ \exists q \in \Inf(\overrightarrow \alpha) \colon B_L(q) = 1 . \]
Also, for every $s \not\in \Inf(\overrightarrow \alpha)$,
\[ B_L(s) = B_L(q) \ \ \ \forall q \not\in \Inf(\overrightarrow \alpha) \]
and
\[ B_L(s) \neq B_L(q) \ \ \ \forall q \in \Inf(\overrightarrow \alpha) . \]

If such $B_L$ always exists, we call $\Lang$ \defword{infinity-postfix-independent}.
\end{mydef}

This definition is as general as possible. It is also well defined if there are an infinity number of equivalence classes of $R$. Thus, $\Lang(R)$ doesn't need to be regular. Also, in that case, there might be an $\alpha \in \Sigma^\omega$ with $\Inf(\overrightarrow \alpha) = \emptyset$.

If $\Lang(R)$ is regular and we look at an $R$-$\omega$-automaton, it basically says that when we visit some state infinitely often, it determines in what loop we are and we cannot switch the loop. Formally:

\begin{lemma}
\label{gen:infPostfixIndep-AutLoops}
Let $R$ be a congruence relation with a finite number of equivalence classes. $\Lang(R)$ is \emph{infinity-postfix-independent} exactly if and only if every SCC $Q$ in the $R$-automata (as defined in section \ref{gen:R-automata}) has exactly one looping subset, i.e. $Q$ itself is the only loop in $Q$.
\begin{proof}
$S_R := \Sigma^*/R$ are the states of the $R$-automata. Let $Q \subseteq S_R$ be any SCC. Let $\tilde L \in \BC \lim \Lang(R)$. Let $\A_M$ be the $R$-Muller-automaton accepting $\tilde L$.

'$\Rightarrow$': Let $\Lang(R)$ be \emph{infinity-postfix-independent}. Then, for $L$, we have an inclusion function $B_L \colon S_R \rightarrow \B$. If there is an accepting loop $Q' \subseteq Q$ in $\A_M$, it means that every $\alpha \in \tilde L$ which ends up in $Q'$ is accepted, thus there is a $q' \in Q'$ with $B_L(q') = 1$. Because we can loop through all of $Q$ and thus construct $\beta \in \Sigma^\omega$ with $\Inf(\overrightarrow \beta) = Q$, we get $B_L(q) = 1$ for all $q \in Q$. Thus, all possible loops in $Q$ will accept. This was general for any SCC and any language $\tilde L \in \BC \lim \Lang(R)$. Because this is a Muller-automaton, this can only be if $Q$ itself is the only loop. Otherwise we can have both an accepting loop and a non-accepting loop in $Q$ which is a contradiction.

'$\Leftarrow$': The SCC $Q$ has exactly one looping subset. This is $Q$ itself. Assuming $Q$ is accepting in $\A_M$. Then define $B_L(q) = 1$ for all $q \in Q$, otherwise $B_L(q) = 0$. This $B_L \colon S_R \rightarrow \B$ has the needed properties, thus $\Lang(R)$ is \emph{infinity-postfix-independent}.
\end{proof}
\end{lemma}

For piecewise testable languages, this is the case.

For locally testable languages, this is \emph{not} the case. Depending on the ending of $\alpha[0,n]$, we can switch through different equivalence classes and visit different loops.

\begin{example}
There is an $R$ so that $\Lang(R)$ is not \emph{infinity-postfix-independent} and
\[ \BC \lim \Lang(R) \cap \lim \Langreg \neq \lim \Lang(R) . \]
\begin{proof}
If we take the example \ref{gen:bcLimLReg-and-limL:counter-example}: For $v,w \in \Set{a,b}^*$, let $v =_R w \ :\Leftrightarrow \ v,w$ end up with the same symbol. I.e., the equivalence classes are $\left<\epsilon\right>, \left<a\right>, \left<b\right>$.

The $R$-automata is
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node[state] (0)              {$\left<\epsilon\right>$};
    \node[state] (2) [right of=0] {$\left<b\right>$};
    \node[state] (1) [above of=2] {$\left<a\right>$};

    \path[->]
    (0) +(-1.5,0) edge (0)
    (0) edge [bend left] node {$a$} (1)
    (0) edge [bend right] node {$b$} (2)
    (1) edge [loop right] node {$a$} ()
    (1) edge [bend left] node {$b$} (2)
    (2) edge [bend left] node {$a$} (1)
    (2) edge [loop right] node {$b$} ()
    ;
  \end{tikzpicture}
\]

From example \ref{gen:bcLimLReg-and-limL:counter-example}, we have $L_a = \left<a\right>$ and $L_b = \left<\epsilon\right> \cup \left<b\right>$ and $\Lang = \Set{L \in \Lang(R)}{\#L = \infty}$ (only the infinity $L \in \Lang(R)$ matter for $\lim$). We also see from the $R$-automata that there is no way to mark states as final states for Büchi-acceptance so that we get the condition "both $a$ and $b$ occur infinitely often". Via Muller, we just mark the loop $\Set{\left<a\right>,\left<b\right>}$ as final. I.e. $\lim L_{ab} \not\in \lim \Lang(R)$ but $\lim L_{ab} \in \BC \lim \Lang(R)$ and as shown in example \ref{gen:bcLimLReg-and-limL:counter-example}, $\lim L_{ab} \in \lim \Langreg$. Thus, $\BC \lim \Lang(R) \cap \lim \Langreg \neq \lim \Lang(R)$.
\end{proof}
\end{example}

This example can actually be extended to be the $\Lang(LT_2)$ class and generalized to any $\Lang(LT_n)$. I.e. for all $n \in \N$, $\Lang(LT_n)$ is not \emph{infinty-postfix-independent} and
\[ \BC \lim \Lang(LT_n) \cap \lim \Langreg \neq \lim \Lang(LT_n) . \]

When studying the \emph{infinity-postfix-independence} property in more detail, we get the surprising result:

\begin{lemma}
\label{gen:BClimR=limR}
Let $R$ be a congruence relation with a finite number of equivalence classes. Let $\Lang(R)$ be \emph{infinity-postfix-independent}. Then %exactly if and only if
\[ \BC \lim \Lang(R) = \lim \Lang(R) . \]
\begin{proof}
$S_R := \Sigma^*/R$ are the states of the $R$-automata. Let $Q \subseteq S_R$ be any SCC. Let $\tilde L \in \BC \lim \Lang(R)$. Let $\A_M$ be the $R$-Muller-automaton accepting $\tilde L$.

%'$\Rightarrow$':
%Let $\Lang(R)$ be \emph{infinity-postfix-independent}. Then,
For $L$, we have an inclusion function $B_L \colon S_R \rightarrow \B$. If there is an accepting loop $Q' \subseteq Q$ in $\A_M$, it means that every $\alpha \in \tilde L$ which ends up in $Q'$ is accepted, thus there is a $q' \in Q'$ with $B_L(q') = 1$. Because we can loop through all of $Q$ and thus construct $\beta \in \Sigma^\omega$ with $\Inf(\overrightarrow \beta) = Q$, we get $B_L(q) = 1$ for all $q \in Q$. Thus, all possible loops in $Q$ will accept. In an $R$-Büchi-automata $\A_B$, we can mark all states of $Q$ as final states. This was for any SCC $Q$, thus $\A_B$ will accept exactly iff $\A_M$ accepts. Thus we have $\tilde L \in \lim \Lang(R)$. This was for any $\tilde L$, i.e. $\BC \lim \Lang(R) = \lim \Lang(R)$.
%
%'$\Leftarrow$': Let $\BC \lim \Lang(R) = \lim \Lang(R)$. Assuming $Q$ has a final state $q \in Q$ in the $R$-Büchi-automata for $\tilde L$. Let $\alpha \in \Sigma^\omega$ so that $q \in \Inf(\overrightarrow \alpha)$.
%
%TODO ...
\end{proof}
\end{lemma}

%\subsection{$\BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R)$}
%S307.6,S307.8
\begin{lemma}
\label{gen:bcLimLReg-and-limL}
Let $R$ be a congruence relation with a finite number of equivalence classes. Let $\Lang(R)$ be \emph{infinity-postfix-independent}. Then
\[ \BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R) . \]

\begin{proof}
In lemma \ref{gen:BClimR=limR}, we showed that we have $\BC \lim \Lang(R) = \lim \Lang(R)$. Because $\lim \Lang(R) \subseteq \lim \Langreg$, we directly get the claimed equality.
\end{proof}
\end{lemma}

%This proof is loosely analogue to the proof in \ref{gen:R-bclim-cap-ext}.

%It was already shown that "$\supseteq$" always holds.

%Now, we show "$\subseteq$". Let $L^\omega \in \BC \lim \Lang(R) \cap \lim \Langreg$. Because $L^\omega \in \lim \Langreg$, there is an Büchi-automaton $\A^B$ which accepts $L^\omega$. We can assume that $\A^B$ is deterministic (with \ref{gen:e-determinism}).

%We must find an $R$-Büchi-automaton which accepts $L^\omega$. We will call it the $\overline{\A}^M$ Büchi-automaton and will construct it in the following.

%Let $\A^M$ be the deterministic $R$-Muller-automaton for $L^\omega$ (according to \ref{gen:R-automata} and \ref{gen:lang_omega_muller}). Without restriction, there are no final state sets in $\A^M$ which are not loops. Then, $\overline{\A}^M$ has the same states and transitions as $\A^M$.

%Look at the SCC $S$ in $\A^M$. Let $q \in S$. Let $\mathcal F_q \subseteq 2^S$ be the set of final states in $\A^M$ with $q \in F$ for all $F \in \F_q$. Let $\mathcal S_q \subseteq 2^S$ be the set of loops in $S$ which include $q$.

%Case 1: $\F_q \neq \mathcal S_q$.

%Case 2: $\F_q = \mathcal S_q$.
%In that case, mark $q$ as a final state in $\overline{\A}^M$.

%For the constructed Büchi-automaton $\overline{\A}^M$, we show that it accepts exactly $L^\omega$.

%Let $\alpha \in L^\omega(\overline{\A}^M)$. Let $q$ be some final state in $\overline{\A}^M$ which is infinitely often visited by $\alpha$. Then, $\F_q = \mathcal S_q$ from the construction. I.e., no matter what loops through $q$ of the related SCC are visited infinitely often by $\alpha$, it will be accepted by $\A^M$. Thus, $\alpha \in L^\omega$.

%Let $\alpha \in L^\omega$. Then, the set of states $F$ infinitely often visited by $\alpha$ in $\A^M$ is some final state set of the Muller-automaton $\A^M$. In $\A^B$, there is a final state $\tilde q$ infinitely often visited by $\alpha$. Let $\alpha =: \prod_{i=1}^{\infty} w_i$ so that $\prod_{i=1}^{n} w_i$ ends up in $\tilde q$ in $\A^B$ for all $n \in \N$ for shortest possible $w_i$ (i.e. we don't miss any $\tilde q$). Let $S$ be the SCC in $\A^M$ where we finally end up with $\alpha$. Then, $F \subseteq S$.

%There must be a $q \in F$ so that $\F_q = \mathcal S_q$. Then, by construction of $\overline{\A}^M$, $q$ is a final state in $\overline{\A}^M$ and thus, $\alpha \in L^\omega(\overline{\A}^M)$.

%Let us show that there is such $q \in F$ by contradiction. I.e. assume there is no such $q \in F$. I.e. for all $q \in F$, $\F_q \neq \mathcal S_q$. Of course we have $F \in \F_q$ for all $q \in F$.

%Let $\mathcal P_{\tilde q}$ be the set of loops in $\A^M$ so that all words which end up looping there infinitely would also visit $\tilde q$ infinitely often in $\A^B$. Of course, all $P \in \mathcal P_{\tilde q}$ will be final state sets in $\A^M$ because $\A^B$ would accept. Define $\mathcal P_{\tilde q,S} := \Set{P \in \mathcal P_{\tilde q}}{P \subseteq S}$. No matter how much other infinte loops in $S$ we add to $\alpha$ so that we still visit some loops from $\mathcal P_{\tilde q,S}$ infinitely often, $\A^M$ and $\A^B$ will keep accepting. Thus, for $P \in \mathcal P_{\tilde q,S}$, every $P' \supseteq P$, $P' \in \mathcal S_S$, we have $P' \in \mathcal P_{\tilde q,S}$.

%For any $q \in F$, we have $\F_q \neq \emptyset$. Thus, $q$ is marked as a final state in $\overline{\A}^M$ and thus, $\overline{\A}^M$ accepts $\alpha$.

%Let us show $\F_q = \mathcal S_q$ under the condition $\F_q \neq \emptyset$. Of course we have $\F_q \subseteq \mathcal S_q$. Let $\A^B$ be the deterministic Büchi automaton for $L^\omega$ (we have $L^\omega \in \lim \Langreg$).
%Let $L_q$ be the set of words which reach $q$ in $\A^M$.
%We show the assumption by contradiction: Let $S \in \mathcal S_q$ with $S \not\in \F_q$. Let $F \in \F_q$ with $F \subseteq S$ or $F \cup S \in \F_q$ (TODO: does that exists?! -> no!).

%Let $L_{q,S} \subseteq \Sigma^*$ be the set of non-looping words from $q \rightarrow q$ in $S$, and likewise $L_{q,F} \subseteq \Sigma^*$ in $F$.

%Let $w \in L_q$, $\overline w_1 \in L_{q,F}$. Then, the infinite states visited by $w \overline w_1$ are exactly $F$. Thus, we have $w \overline w_1 \in L^\omega$.
%Let $\overline w_2 \in L_{q,S}$.
%In $\A^B$, after $w \cdot \Set{\overline w_1, \overline w_2}^\omega$, we will eventually reach a final SCC $S_B$. Let $\tilde w \in w \cdot \Set{\overline w_1, \overline w_2}^*$, so that $\tilde w$ reaches $S_B$. We have $\tilde w \cdot \Set{\overline w_1,\overline w_2}^* \cdot \overline w_1^\omega \subseteq L^\omega$.

%Let $W := \tilde w \cdot \Set{\overline w_1,\overline w_2}^*$, $W_1 := \overline w_1^+$, $W_2 := (\overline w_1^* \overline w_2 \overline w_1^*)^+$.
%Search $q_B \in S_B$ with $W \rightarrow q_B$, $q_B \xrightarrow{W_1} q_B$ and $q_B \xrightarrow{W_2} q_B$. Assuming such a $q_B$ exists with $\tilde w_0 \in W$, $\tilde w_1 \in W_1$, $\tilde w_2 \in W_2$ so that $\tilde w_0 \rightarrow q_B$, $q_B \xrightarrow{\tilde w_i} q_B$ for $i \in \Set{1,2}$. Because $\tilde w_0 \cdot \tilde w_1^\omega \in L^\omega$, there is a final state $\tilde q_B$ in $\A^B$ on the path $q_B \xrightarrow{\tilde w_1} q_B$. Then, $\beta := \tilde w_0 \cdot (\tilde w_1 \cdot \tilde w_2)^\omega$ also visits $\tilde q_B$ infinitely often, thus $\A^B$ also accepts $\beta$. In $\A^M$, $\beta$ visits exactly $F \cup S$ infinitely often. Thus, $\A_M$ does not accept $\beta$. That is a contradiction. Thus, $\F_q = \mathcal S_q$.

%TODO: Now show that such $q_B$ exists with $\tilde w_0 \in W$, $\tilde w_1 \in W_1$, $\tilde w_2 \in W_2$.

%---
%
%Note that this proof does not work for any $\A^M$. E.g. the language
%\[ \Set{\alpha \in \Set{a,b}^\omega}{\text{$a$ and $b$ do occur infinitely often in $\alpha$}} \]
%is accepted exactly by the Muller automaton
%\[
%  \begin{tikzpicture}[%
%    >=stealth,
%	shorten >=1pt,
%	node distance=2cm,
%    auto,
%  ]
%    \node[state] (1)              {$1$};
%    \node[state] (2) [right of=1] {$2$};
%
%    \path[->]
%    (1) +(-1.5,0) edge (1)
%    (1) edge [loop above] node {$a$} ()
%    (1) edge [bend left] node {$b$} (2)
%    (2) edge [bend left] node {$a$} (1)
%    (2) edge [loop above] node {$b$} ()
%    ;
%  \end{tikzpicture}
%\]
%where $\F = \Set{\Set{1,2}}$. It is not possible to find a final state set to Büchi-accept this language based on this state/transition graph, thus this automaton would not work in the proof. It is not possible to accept this language with a Muller automaton with less states, so in some way the given automaton is minimal. This demonstrates that some form of minima restriction/condition on $\A^M$ would not work for the proof.

%TODO: then show that if not (P), then not equality

The question arises wether \emph{infinity-postfix-independence} on $\Lang(R)$ is equivalent to the equality $\BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R)$. We have shown in lemma \ref{gen:infPostfixIndep-AutLoops} that if $\Lang(R)$ is not \emph{infinity-postfix-independent}, there must be a SCC $Q \subseteq S_R$ with more than one loop.

\begin{example}
There is a congruence relation $R$ with a finite number of equivalence classes where $\Lang(R)$ is not \emph{infinity-postfix-independent} but we still have
\[ \BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R) . \]
\begin{proof}
Look at the fully connected transition graph over $\Sigma := \Set{a,b}$:
\[
  \begin{tikzpicture}[%
    >=stealth,
	shorten >=1pt,
	node distance=2cm,
    auto,
  ]
    \node[state] (1)              {$1$};
    \node[state] (2) [right of=1] {$2$};
    \node[state] (3) [below of=2] {$3$};
    \node[state] (4) [below of=1] {$4$};
    \node[state] (5) [right of=3] {$5$};

    \path[->]
    (1) +(-1.5,0) edge (1)
    (1) edge [bend left] node {$a$} (2)
    (2) edge node {$a$} (1)
    (2) edge node {$b$} (3)
    (3) edge node {$b$} (1)
    (1) edge [bend right] node {$b$} (4)
    (2) edge node {$a$} (5)
    (3) edge [bend right] node {$a$} (5)
    (4) edge [loop below] node {$a, b$} ()
    (5) edge [loop below] node {$a, b$} ()
    ;
  \end{tikzpicture}
\]
Define the congruence relation $R \subseteq (\Sigma^*,\Sigma^*)$ via the transition graph: $(v,w) \in R \ :\Leftrightarrow \ v,w$ end up in the same state. Then, the $R$-automata is exactly the transition graph. Look at the SCC $Q := \Set{1,2,3}$. $Q$ has two loops $P_1 := \Set{1,2}$ and $P_2 := Q$, where $P_1 \subsetneqq P_2$. Thus, $\Lang(R)$ is not \emph{infinity-postfix-independent}. Let $\tilde L$ be the language accepted by the $R$-Muller-automaton which only accepts the loop $P_1$. Then, $\tilde L$ is not recognizable by a deterministic Büchi automaton. Thus, we also have $\BC \lim \Lang(R) \neq \lim \Lang(R)$.

The $R$-Muller-automaton only accepting $P_2$ is equivalent to the $R$-Büchi-automaton only accepting state $3$. The $R$-Muller-automaton accepting both $P_1$ and $P_2$ is equivalent to the $R$-Büchi-automaton accepting $Q$.

All other $R$-Büchi-automata can be constructed canonically from that. Thus we have
\[ \BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R) . \]
\end{proof}
\end{example}

However, if we get stricter on the possible subloops, we can show the inequality.
\begin{mydef}
Let $R$ be a congruence relation with a finite number of equivalence classes.

If there is a SCC $Q \subseteq S_R$ including two loops $P_1,P_2 \subseteq Q$, $P_1 \neq P_2$ with $P_1 \not\subseteq P_2$, $P_2 \not\subseteq P_1$, then call $\Lang(R)$ \defword{postfix-loop-deterministic}.
\end{mydef}

\begin{lemma}
\label{gen:postfixloopdet->BclimAndLreg=lim}
Let $R$ be a congruence relation with a finite number of equivalence classes. And let $\Lang(R)$ be \emph{postfix-loop-deterministic}. Then
\[ \BC \lim \Lang(R) \cap \lim \Langreg \neq \lim \Lang(R) . \]
\begin{proof}
There is a SCC $Q \subseteq S_R$ including two loops $P_1,P_2 \subseteq Q$, $P_1 \neq P_2$ with $P_1 \not\subseteq P_2$ and $P_2 \not\subseteq P_1$. They are in the same SCC $Q$, thus there is an outer loop $P \subseteq Q$ with $P_1,P_2 \subseteq P$. In the $R$-Muller-automaton, let $P$ be the only final state set. Let $\tilde L$ be the language accepted by this. For every $q \in Q$, look at the $R$-Büchi-automaton where $q$ is the only final state. The intersection of all these is recognized by a deterministic Büchi automaton (lemma \ref{reg:limRegClosedIntersection}). And the intersection accepts exactly $\tilde L$. Thus, $\tilde L \in \BC \lim \Lang(R) \cap \lim \Langreg$. However, there is no way in the $R$-Büchi-automaton to mark a subset of $Q$ as the final states such that we accept $\tilde L$. Thus, $\tilde L \not\in \lim \Lang(R)$.
\end{proof}
\end{lemma}

Now, the question arises wether \emph{postfix-loop-determinism} is equivalent to the inequality.
\begin{lemma}
\label{gen:postfixloopdet<-BclimAndLreg=lim}
Let $\Lang(R)$ be not \emph{postfix-loop-deterministic}. Then
\[ \BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R) . \]
\begin{proof}
For all SCC $Q$ and subloops $P_1,P_2 \subseteq Q$, we either have $P_1 = P_2$ or $P_1 \subseteq P_2$ or $P_2 \subseteq P_1$. If we have always $P_1 = P_2$ for this $Q$, it means that $Q$ has only one loop. Then, if an $R$-Muller-automaton accepts $Q$, we can just mark any state $q \in Q$ final in a $R$-Büchi-automaton and every $\alpha$ going through $Q$ would be accepted by the $R$-Büchi-automata exactly if it would be accepted by the $R$-Muller-automata. 

Now, assume that there is $P_1 \subseteq P_2$. If $R$-Muller would accept $P_1$ but not $P_2$, the resulting language would not be recognizable by deterministic Büchi automata, thus we would be out of $\lim \Langreg$. If $R$-Muller accepts $P_2$ but not $P_1$, we mark some state from $P_2 - P_1$ as final in the $R$-Büchi automaton. If it accepts both, we mark some state from $P_1$ as fina in $R$-Büchi. In either case, we are in $\lim \Lang(R)$. If there are other loops $P' \subseteq Q$, they are either supersets of $P_2$ or subsets of $P_1$ and thus we can use the same argumentation.

We showed that for all SCC of the $R$-automata. Thus we have shown the claimed equality.
\end{proof}
\end{lemma}

Thus, we get the final result
\begin{theorem}
\label{gen:postfix-loop-det=limAndBclim}
$\Lang(R)$ is \emph{postfix-loop-deterministic} exactly if and only if
\[ \BC \lim \Lang(R) \cap \lim \Langreg = \lim \Lang(R) . \]
\begin{proof}
Lemma \ref{gen:postfixloopdet->BclimAndLreg=lim} and lemma \ref{gen:postfixloopdet<-BclimAndLreg=lim}.
\end{proof}
\end{theorem}

\begin{lemma}
\label{gen:R-staiger-wagner}
%\subsection{$\lim \Lang(R) \cap \dlim \Lang(R) = \BC \ext \Lang(R)$}
\[ \lim \Lang(R) \cap \dlim \Lang(R) = \BC \ext \Lang(R) \]
\begin{proof}
TODO...
\end{proof}
\end{lemma}



